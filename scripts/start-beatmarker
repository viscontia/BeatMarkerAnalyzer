#!/bin/bash

# BeatMarkerAnalyzer - Script di avvio automatico
# Uso: start-beatmarker
#
# Funzioni:
# 1. Kill processi attivi su porta 5173
# 2. Avvio server di sviluppo
# 3. (Build skippata per velocitÃ )

set -e  # Exit on error

# Colori per output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Directory del progetto BeatMarkerAnalyzer
PROJECT_DIR="/Users/adrianovisconti/Documents/Sviluppo Software/GitHub/BeatMarkerAnalyzer"
PORT=5173

echo -e "${BLUE}ğŸµ BeatMarkerAnalyzer - Script di avvio${NC}"
echo "================================================="

# Funzione per stampare step
print_step() {
    echo -e "\n${YELLOW}ğŸ“‹ Step $1: $2${NC}"
}

# Funzione per controllo directory progetto
check_project_dir() {
    if [ ! -d "$PROJECT_DIR" ]; then
        echo -e "${RED}âŒ Errore: Directory progetto non trovata${NC}"
        echo "   Path: $PROJECT_DIR"
        exit 1
    fi

    if [ ! -f "$PROJECT_DIR/package.json" ]; then
        echo -e "${RED}âŒ Errore: package.json non trovato${NC}"
        exit 1
    fi

    echo -e "${GREEN}âœ… Directory progetto valida${NC}"
}

# Funzione per kill processi su porta specifica
kill_port_processes() {
    local port=$1
    echo "ğŸ” Controllo processi attivi sulla porta $port..."

    # Find process using the port
    local pids=$(lsof -ti :$port 2>/dev/null || true)

    if [ -n "$pids" ]; then
        echo -e "${YELLOW}âš ï¸  Trovati processi attivi sulla porta $port:${NC}"
        echo "$pids" | while read -r pid; do
            if [ -n "$pid" ]; then
                local process_info=$(ps -p $pid -o pid,comm 2>/dev/null || echo "N/A")
                echo "   PID $pid: $process_info"
            fi
        done

        echo "ğŸ”ª Terminazione processi..."
        echo "$pids" | xargs -r kill -9 2>/dev/null || true

        # Verifica che i processi siano terminati
        sleep 2
        local remaining=$(lsof -ti :$port 2>/dev/null || true)
        if [ -n "$remaining" ]; then
            echo -e "${RED}âŒ Alcuni processi non sono stati terminati${NC}"
            return 1
        else
            echo -e "${GREEN}âœ… Tutti i processi sulla porta $port terminati${NC}"
        fi
    else
        echo -e "${GREEN}âœ… Nessun processo attivo sulla porta $port${NC}"
    fi
}

# Funzione per avvio server di sviluppo
start_dev_server() {
    echo "ğŸš€ Avvio server di sviluppo..."
    cd "$PROJECT_DIR"

    # Controllo dipendenze
    if [ ! -d "node_modules" ]; then
        echo "ğŸ“¦ Installazione dipendenze..."
        npm install
    fi

    echo "ğŸŒ Avvio npm run dev..."

    # Avvia server di sviluppo in foreground
    exec npm run dev
}

# Funzione principale
main() {
    print_step "1" "Controllo directory progetto"
    check_project_dir

    print_step "2" "Terminazione processi esistenti"
    kill_port_processes $PORT

    print_step "3" "Avvio server di sviluppo"
    echo ""
    echo "================================================="
    echo -e "${GREEN}ğŸ‰ Avvio BeatMarkerAnalyzer...${NC}"
    echo ""
    echo -e "ğŸ“± URL Locale:    ${BLUE}http://localhost:$PORT${NC}"
    echo -e "ğŸ“ Directory:     ${BLUE}$PROJECT_DIR${NC}"
    echo -e "ğŸ›‘ Per fermare:   ${YELLOW}Ctrl+C${NC}"
    echo ""
    echo "================================================="

    start_dev_server
}

# Gestione segnali per cleanup
cleanup() {
    echo -e "\n${YELLOW}ğŸ›‘ Arresto del server...${NC}"
    kill_port_processes $PORT
    echo -e "${GREEN}âœ… Cleanup completato${NC}"
    exit 0
}

trap cleanup SIGINT SIGTERM

# Esecuzione principale
main "$@"