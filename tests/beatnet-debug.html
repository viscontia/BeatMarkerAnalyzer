<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatNet+ Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }
        button:hover {
            background: #00ff0020;
        }
        .log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .beats {
            background: #002200;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 10px 0;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
        .warning {
            color: #ffff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ BeatNet+ Debug Test</h1>

        <div>
            <button onclick="loadTestAudio()">üìÅ Load Test Audio (Neon Nights)</button>
            <button onclick="startBeatNetDebug()">üöÄ Start BeatNet+ Debug</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
        </div>

        <div>
            <h3>üìä Audio Info</h3>
            <div id="audioInfo">No audio loaded</div>
        </div>

        <div>
            <h3>ü•Å Beat Events</h3>
            <div id="beats" class="beats">Waiting for beats...</div>
        </div>

        <div>
            <h3>üìù Debug Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        let audioBuffer = null;
        let audioContext = null;
        let beatNetService = null;
        let beatCount = 0;
        let downbeatCount = 0;

        // Log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[BeatNet+ Debug] ${message}`);
        }

        // Clear log
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('beats').innerHTML = 'Waiting for beats...';
            beatCount = 0;
            downbeatCount = 0;
        }

        // Load test audio
        window.loadTestAudio = async function() {
            try {
                log('üìÅ Loading test audio: Ikoliks - Neon Nights.wav', 'info');

                const audioPath = '../Example/Ikoliks - Neon Nights.wav';
                log(`üîó Fetching: ${audioPath}`, 'info');
                const response = await fetch(audioPath);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                log(`‚úÖ File loaded: ${(arrayBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`, 'success');

                // Create AudioContext if needed
                if (!audioContext) {
                    audioContext = new AudioContext({ sampleRate: 44100 });
                    log(`üîä AudioContext created: ${audioContext.sampleRate} Hz`, 'info');
                }

                // Decode audio
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                log(`üéµ Audio decoded successfully`, 'success');

                // Show audio info
                const audioInfo = document.getElementById('audioInfo');
                audioInfo.innerHTML = `
                    <strong>Duration:</strong> ${audioBuffer.duration.toFixed(2)}s<br>
                    <strong>Sample Rate:</strong> ${audioBuffer.sampleRate} Hz<br>
                    <strong>Channels:</strong> ${audioBuffer.numberOfChannels}<br>
                    <strong>Length:</strong> ${audioBuffer.length} samples
                `;

            } catch (error) {
                log(`‚ùå Failed to load audio: ${error.message}`, 'error');
            }
        }

        // Start BeatNet+ debug
        window.startBeatNetDebug = async function() {
            if (!audioBuffer) {
                log('‚ö†Ô∏è No audio loaded. Load test audio first.', 'warning');
                return;
            }

            try {
                log('üéØ Starting BeatNet+ debug test...', 'info');

                // Import BeatNet+ service
                const { beatNetPlusService } = await import('../src/services/beatNetPlusService.js');
                beatNetService = beatNetPlusService;

                log('üì¶ BeatNet+ service imported', 'success');

                // Setup beat event handler
                const unsubscribe = beatNetService.onBeat((beatEvent) => {
                    beatCount++;
                    if (beatEvent.downbeat) {
                        downbeatCount++;
                    }

                    const beatType = beatEvent.downbeat ? 'üî¥ DOWNBEAT' : 'üü¢ Beat';
                    log(`ü•Å ${beatType}: t=${beatEvent.timestamp.toFixed(3)}s, tempo=${beatEvent.tempo.toFixed(1)}, conf=${beatEvent.confidence.toFixed(3)}`, 'success');

                    // Update beats display
                    const beatsDiv = document.getElementById('beats');
                    beatsDiv.innerHTML = `
                        <strong>Total Beats:</strong> ${beatCount}<br>
                        <strong>Downbeats:</strong> ${downbeatCount}<br>
                        <strong>Last Beat:</strong> ${beatEvent.timestamp.toFixed(3)}s (${beatEvent.downbeat ? 'downbeat' : 'beat'})<br>
                        <strong>Tempo:</strong> ${beatEvent.tempo.toFixed(1)} BPM<br>
                        <strong>Confidence:</strong> ${(beatEvent.confidence * 100).toFixed(1)}%
                    `;
                });

                log('üîÑ Initializing BeatNet+ service...', 'info');
                await beatNetService.initialize(audioBuffer.sampleRate);
                log('‚úÖ BeatNet+ service initialized', 'success');

                log('üöÄ Starting audio processing...', 'info');
                await beatNetService.startProcessingBuffer(audioBuffer);
                log('‚úÖ Audio processing started', 'success');

                // Set timeout to stop processing
                const duration = audioBuffer.duration;
                setTimeout(async () => {
                    await beatNetService.stopProcessing();
                    unsubscribe();
                    log(`üèÅ Processing completed. Total: ${beatCount} beats, ${downbeatCount} downbeats in ${duration.toFixed(2)}s`, 'success');

                    if (beatCount === 0) {
                        log('‚ö†Ô∏è NO BEATS DETECTED! Check AudioWorklet and WebWorker logs.', 'error');
                    }
                }, (duration + 2) * 1000);

            } catch (error) {
                log(`‚ùå BeatNet+ debug failed: ${error.message}`, 'error');
                console.error('BeatNet+ debug error:', error);
            }
        }

        // Initialize
        log('üîß BeatNet+ Debug Test initialized', 'info');
        log('üìù Use browser console to see detailed logs from AudioWorklet and WebWorker', 'warning');

        // Global error handler
        window.addEventListener('error', function(e) {
            log(`‚ùå Global error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            log(`‚ùå Unhandled promise rejection: ${e.reason}`, 'error');
        });

    </script>
</body>
</html>